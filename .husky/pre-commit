#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

npm run lint-staged

# Run tests for changed packages
echo "ðŸ§ª Running tests for changed files..."

# Check if security package has changes
if git diff --cached --name-only | grep -q "packages/security/"; then
  echo "ðŸ“¦ Running security tests..."
  npm test -w @primo-poker/security -- --bail --findRelatedTests
fi

# Check if persistence package has changes
if git diff --cached --name-only | grep -q "packages/persistence/"; then
  echo "ðŸ“¦ Running persistence tests..."
  npm test -w @primo-poker/persistence -- --bail --findRelatedTests
fi

# Check if any critical files were changed
CRITICAL_FILES="wallet-manager|secure-shuffle|authentication|crypto-helpers"
if git diff --cached --name-only | grep -qE "$CRITICAL_FILES"; then
  echo "ðŸš¨ Critical files changed - running full test suite..."
  npm test -- --bail
fi

echo "âœ… Pre-commit checks passed!"
